{% extends "tra_theme/base.html" %}
{% load static %}
{% block title %}Rate Public Transport{% endblock %}
{% block content %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/rateyo@2.3.2/min/jquery.rateyo.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'rating/css/rating.css' %}">

    <h1>Rate {{motor_type_name}}</h1>

   <form method="POST" action="{% url 'wizard_step_ratemotor' %}">
        {% csrf_token %}
            <input type="hidden" name="motor_type" value="{{ motor_type_key }}">

        <!-- Hidden Motor Type Field -->


        <!-- MotorCar Number -->
        <div class="form-field">
            {{ form.motor_car_number.label_tag }}
            {{ form.motor_car_number }}
            {% if form.motor_car_number.errors %}
                <div class="error">{{ form.motor_car_number.errors|join:", " }}</div>
            {% endif %}
        </div>

        <!-- Hidden 'score' field -->
        {{ form.score }}
        {{ form.location }}
        {{ form.device_id }}

        <!-- Star widget container -->
        <div class="form-field">
            <label>Rate:</label>
            <div id="rateYo"></div>
            {% if form.score.errors %}
                <div class="error">{{ form.score.errors|join:", " }}</div>
            {% endif %}
        </div>

        <!-- Pre-Captured Comments -->
        <div id="ratingComments"></div>

        <!-- Other Comment Field -->
        <textarea id="otherCommentField" name="comment" placeholder="Specify your feedback here..."></textarea>

        <!-- System Comments -->
        <input type="hidden" id="id_system_comments" name="system_comments" value="">
        {% if form.system_comments.errors %}
            <div class="error">{{ form.system_comments.errors|join:", " }}</div>
        {% endif %}

        <br>
        <button type="submit" id="rateButton" name="action" value="rate" disabled>Rate {{motor_type_name}}</button>
    </form>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/rateyo@2.3.2/min/jquery.rateyo.min.js"></script>



<a href="{% url 'wizard_step_motormake' %}" class="btn">Change Motor Type</a>


<script src="{% static 'rating/js/rating.js' %}"></script>

<script>

    $(function () {
    const rateButton = document.getElementById("rateButton");
    const scoreField = document.getElementById("id_score");
    const systemCommentsField = document.getElementById("id_system_comments");
    const otherCommentField = document.getElementById("otherCommentField");
    const numberPlateField = document.getElementById("id_motor_car_number");

    function checkRequiredFields() {
        const numberPlate = numberPlateField ? numberPlateField.value.trim() : "";
        const score = parseFloat(scoreField.value) || 0;
        const selectedComments = document.querySelectorAll(".comment-option.selected");
        // Determine if "Other" is among the selected comments
        const otherSelected = Array.from(selectedComments).some(el => el.textContent === "Other");
        return (numberPlate !== "" && score > 0 && selectedComments.length > 0 && (!otherSelected || otherCommentField.value.trim() !== ""));
    }

    function updateButtonState() {
        rateButton.disabled = !checkRequiredFields();
    }

    function generateComments(rating) {
        const commentsContainer = document.getElementById("ratingComments");
        commentsContainer.innerHTML = "";
        let comments = [];
        if (rating <= 2.5) {
            comments = [
                "Drove too fast or recklessly",
                "Ignored traffic rules",
                "Sudden braking or jerky driving",
                "Car was unclean or uncomfortable",
                "Driver was late or caused delays",
                "Distracted while driving",
                "Other"
            ];
        } else if (rating > 2.5 && rating <= 4) {
            comments = [
                "Decent driving but could improve",
                "Followed most traffic rules",
                "Car cleanliness could be better",
                "Minor delays during the trip",
                "Driving was okay but not outstanding",
                "Other"
            ];
        } else {
            comments = [
                "Polite and professional driver",
                "Smooth and safe driving",
                "Followed traffic rules",
                "Clean and comfortable car",
                "Punctual and timely",
                "Attentive to road conditions",
                "Other"
            ];
        }

        comments.forEach(function (comment) {
            const div = document.createElement("div");
            div.className = "comment-option";
            div.textContent = comment;
            div.onclick = function () {
                selectComment(div, comment);
            };
            commentsContainer.appendChild(div);
        });
    }

    function restoreSelectedComments() {
        if (!systemCommentsField) return;
        const saved = systemCommentsField.value;
        if (!saved) return;

        const savedComments = saved.split(',').map(s => s.trim());
        document.querySelectorAll(".comment-option").forEach(function (option) {
            if (savedComments.includes(option.textContent)) {
                option.classList.add("selected");
            }
            if (option.textContent === "Other") {
                // Look for a saved value like "Other: <free text>"
                const otherSaved = savedComments.find(s => s.startsWith("Other:"));
                if (otherSaved) {
                    option.classList.add("selected");
                    otherCommentField.style.display = "block";
                    otherCommentField.value = otherSaved.substring(6).trim();
                    otherCommentField.required = true;
                }
            }
        });

        updateButtonState();
    }

    // **** Modified updateSystemComments function ****
    function updateSystemComments() {
        const selectedOptions = Array.from(document.querySelectorAll(".comment-option.selected"));
        // Get all selected options that are not "Other"
        const nonOtherOptions = selectedOptions.filter(el => el.textContent === "Other" ? false : true);
        const otherOptionSelected = selectedOptions.some(el => el.textContent === "Other");

        if (otherOptionSelected) {
            // Always include the Other free text along with any standard options.
            if (nonOtherOptions.length > 0) {
                systemCommentsField.value = nonOtherOptions.map(el => el.textContent).join(", ") + ", Other: " + otherCommentField.value.trim();
            } else {
                systemCommentsField.value = "Other: " + otherCommentField.value.trim();
            }
        } else {
            systemCommentsField.value = nonOtherOptions.map(el => el.textContent).join(", ");
        }
    }

// Also update the event listener so that changes in the free entry trigger an update.
otherCommentField.addEventListener("input", function () {
    updateSystemComments();
    updateButtonState();
});


    function selectComment(element, comment) {
        element.classList.toggle("selected");
        if (comment === "Other") {
            otherCommentField.style.display = element.classList.contains("selected") ? "block" : "none";
            otherCommentField.required = element.classList.contains("selected");
        }
        updateSystemComments();
        updateButtonState();
    }

    // Update system comments whenever the free entry text changes.
    otherCommentField.addEventListener("input", function () {
        updateSystemComments();
        updateButtonState();
    });

    let initialRating = parseFloat(scoreField.value) || 0.0;
    $("#rateYo").rateYo({
        rating: initialRating,
        halfStar: true,
        starWidth: "30px",
        ratedFill: "#F39C12",
        normalFill: "#C0C0C0",
        onSet: function (rating) {
            scoreField.value = rating;
            updateButtonState();
            generateComments(rating);
            setTimeout(restoreSelectedComments, 50);
        }
    });

    if (initialRating > 0) {
        rateButton.disabled = false;
        generateComments(initialRating);
        setTimeout(restoreSelectedComments, 50);
    } else {
        rateButton.disabled = true;
    }

    if (numberPlateField) {
        numberPlateField.addEventListener("input", updateButtonState);
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const locationField = document.getElementById("id_location");
                if (locationField) {
                    locationField.value = `${lat},${lng}`;
                } else {
                    console.error("Location field not found in the form.");
                }
            },
            function (error) {
                alert("Unable to capture location. Please allow location access in your browser settings.");
                console.error("Geolocation error:", error.message);
            },
            { enableHighAccuracy: true }
        );
    } else {
        alert("Geolocation is not supported by your browser.");
        console.error("Geolocation is not supported by this browser.");
    }
});

</script>
{% endblock %}