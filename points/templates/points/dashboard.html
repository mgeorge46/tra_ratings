{% extends "tra_theme/base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        background: #f8f9fa;
    }

    h2, h4 {
        color: #2a5298;
        font-weight: 600;
    }

    .card-title {
        font-weight: 500;
    }

    .tab-nav .nav-link {
        background-color: #e9ecef;
        color: #333;
        margin-right: 5px;
        border-radius: 8px;
    }

    .tab-nav .nav-link.active {
        background-color: #2a5298;
        color: white;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .table thead {
        background-color: #2a5298;
        color: white;
    }

    .table-striped tbody tr:hover {
        background-color: #e3f2fd;
    }

    .form-select {
        min-width: 200px;
    }

     .nav-link {
    cursor: pointer !important;
  }

}
</style>

<div class="container py-4">
    <h2 class="mb-4">üöÄ Admin Dashboard</h2>

    <!-- Weekly Activity Chart -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">üìà Weekly Rating Activity (Last 8 Weeks)</h5>
            <canvas id="weeklyTrendChart"></canvas>
        </div>
    </div>

    <!-- Weekly Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center shadow-sm border-success">
                <div class="card-body">
                    <h6>Total Ratings</h6>
                    <p class="fs-4 text-success">{{ weekly_stats.total_ratings }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm border-primary">
                <div class="card-body">
                    <h6>Active Raters</h6>
                    <p class="fs-4 text-primary">{{ weekly_stats.active_users }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center shadow-sm border-warning">
                <div class="card-body">
                    <h6>Average/User</h6>
                    <p class="fs-4 text-warning">{{ weekly_stats.avg_ratings_per_user }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav tab-nav nav-pills mb-3">
        <li class="nav-item"><a class="nav-link active" onclick="openTab('top')">üèÜ Top Contributors</a></li>
        <li class="nav-item"><a class="nav-link" onclick="openTab('bonus')">üì© Bonus Report</a></li>
        <li class="nav-item"><a class="nav-link" onclick="openTab('log')">üìä Notification Logs</a></li>
    </ul>

    <!-- Top Contributors -->
    <div class="tab-content active" id="top">
        <h4 class="mb-3">Top Contributors</h4>
        <canvas id="topChart" class="mb-3"></canvas>
        <table class="table table-striped table-hover shadow-sm">
            <thead><tr><th>User</th><th>Points</th><th>Level</th></tr></thead>
            <tbody>
                {% for c in contributors %}
                <tr><td>{{ c.user.email|default:c.user.contact_number }}</td><td>{{ c.points }}</td><td>{{ c.level }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Bonus Report -->
    <div class="tab-content" id="bonus">
        <h4 class="mb-3">Bonus Award Log</h4>
        <form method="get" class="mb-3">
            <label class="form-label me-2">Filter by Week:</label>
            <select name="bonus_date" class="form-select d-inline-block w-auto" onchange="this.form.submit()">
                <option value="">All</option>
                {% for d in unique_bonus_dates %}
                <option value="{{ d }}" {% if d|stringformat:"s" == selected_bonus_date %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
        </form>
        <canvas id="bonusTrendChart" class="mb-3"></canvas>
        <table class="table table-striped table-hover shadow-sm">
            <thead><tr><th>User</th><th>Week</th><th>Awarded At</th></tr></thead>
            <tbody>
                {% for log in bonus_logs %}
                <tr><td>{{ log.user.email|default:log.user.contact_number }}</td><td>{{ log.week_start }}</td><td>{{ log.awarded_at }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Notification Logs -->
    <div class="tab-content" id="log">
        <h4 class="mb-3">Notification Log</h4>
        <table class="table table-striped table-hover shadow-sm">
            <thead><tr><th>User</th><th>Type</th><th>Status</th><th>Date</th></tr></thead>
            <tbody>
                {% for n in notifications %}
                <tr><td>{{ n.user.email|default:n.user.contact_number }}</td><td>{{ n.channel }}</td><td>{{ n.status }}</td><td>{{ n.created_at }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- JavaScript -->
<script>
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        event.target.classList.add('active');
    }

    const topLabels = [ {% for c in contributors %}"{{ c.user.email|default:c.user.contact_number }}",{% endfor %} ];
    const topPoints = [ {% for c in contributors %}{{ c.points }},{% endfor %} ];
    new Chart(document.getElementById('topChart'), {
        type: 'bar',
        data: {
            labels: topLabels,
            datasets: [{
                label: 'Points',
                data: topPoints,
                backgroundColor: 'rgba(54, 162, 235, 0.6)'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false }},
            scales: { y: { beginAtZero: true } }
        }
    });

    const weeklyLabels = [ {% for t in weekly_trends %}"{{ t.week|date:'Y-m-d' }}",{% endfor %} ];
    const weeklyValues = [ {% for t in weekly_trends %}{{ t.total }},{% endfor %} ];
    new Chart(document.getElementById('weeklyTrendChart'), {
        type: 'line',
        data: {
            labels: weeklyLabels,
            datasets: [{
                label: 'Ratings per Week',
                data: weeklyValues,
                borderColor: '#ff9800',
                backgroundColor: '#ffe0b2',
                fill: false,
                tension: 0.4
            }]
        },
        options: { responsive: true }
    });

    const bonusLabels = [ {% for d in bonus_labels %}"{{ d }}",{% endfor %} ];
    const bonusCounts = [ {% for count in bonus_counts %}{{ count }},{% endfor %} ];
    new Chart(document.getElementById('bonusTrendChart'), {
        type: 'line',
        data: {
            labels: bonusLabels,
            datasets: [{
                label: 'Bonuses Awarded',
                data: bonusCounts,
                borderColor: '#9c27b0',
                backgroundColor: '#f3e5f5',
                fill: false,
                tension: 0.4
            }]
        },
        options: { responsive: true }
    });
</script>

{% endblock %}
